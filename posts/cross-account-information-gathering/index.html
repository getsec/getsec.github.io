<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Describe all the things in AWS :: Blog — @me</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="How can query multiple accounts for a lot of informaiton. Well theres a few ways we can do this. Honestly what I beleive is that leveraging a cross account role in each account is one the best ways to hadle this. This allows for us to have the one spot for control and access. If you have a way to deploy this role in an automated way, that would be best."/>
<meta name="keywords" content="AWS, Amazon, info, enumeration"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/cross-account-information-gathering/" />




<link rel="stylesheet" href="/assets/style.css">






<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">

<link rel="shortcut icon" href="/img/favicon/orange.png">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Describe all the things in AWS :: Blog — @me" />
<meta name="twitter:description" content="How can query multiple accounts for a lot of informaiton. Well theres a few ways we can do this. Honestly what I beleive is that leveraging a cross account role in each account is one the best ways to hadle this. This allows for us to have the one spot for control and access. If you have a way to deploy this role in an automated way, that would be best." />
<meta name="twitter:site" content="/" />
<meta name="twitter:creator" content="Nathan Getty" />
<meta name="twitter:image" content="">


<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Describe all the things in AWS :: Blog — @me">
<meta property="og:description" content="How can query multiple accounts for a lot of informaiton. Well theres a few ways we can do this. Honestly what I beleive is that leveraging a cross account role in each account is one the best ways to hadle this. This allows for us to have the one spot for control and access. If you have a way to deploy this role in an automated way, that would be best." />
<meta property="og:url" content="/posts/cross-account-information-gathering/" />
<meta property="og:site_name" content="Describe all the things in AWS" />
<meta property="og:image" content="">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2020-01-29 10:04:03.128 &#43;0000 UTC" />











</head>
<body class="">


<div class="container headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Terminal
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/content/meta/about-me/">About</a></li>
        
      
      
    

    
    <div class="spacer"></div>
    <ul class="language-selector">
      <ul class="language-selector-current">
          <li>English ▾</li>
      </ul>
      <ul class="language-selector__more hidden">
        
      </ul>
    </ul>
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/content/meta/about-me/">About</a></li>
      
    
    
    <hr />
        
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="/posts/cross-account-information-gathering/">Describe all the things in AWS</a></h1>
  <div class="post-meta">
      
    <span class="post-date">
      2020-01-29
    </span>
    
    
    <span class="post-author">::
      Nathan Getty
    </span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="/tags/aws/">AWS</a>&nbsp;
    
    #<a href="/tags/amazon/">Amazon</a>&nbsp;
    
    #<a href="/tags/info/">info</a>&nbsp;
    
    #<a href="/tags/enumeration/">enumeration</a>&nbsp;
    
  </span>
  

  

  <div class="post-content"><div>
        <h2 id="how-can-query-multiple-accounts-for-a-lot-of-informaiton">How can query multiple accounts for a lot of informaiton.<a href="#how-can-query-multiple-accounts-for-a-lot-of-informaiton" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Well theres a few ways we can do this. Honestly what I beleive is that leveraging a cross account role in each account is one the best ways to hadle this. This allows for us to have the one spot for control and access. If you have a way to deploy this role in an automated way, that would be best.</p>
<h2 id="ok-so-whats-the-deal-cant-we-just-loop-and-shoot">Ok so whats the deal, cant we just loop and shoot.<a href="#ok-so-whats-the-deal-cant-we-just-loop-and-shoot" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>So, we can iterate through each account and each region you operate in and do some math. The factors we will be using is events x accounts x regions. Lets say you have 20 AWS accounts and operate in three seperate regions, you want to run 50 API calls to find information about your environment, so what do you do. Write a <em>for loop</em> to iterate over that.</p>
<p>Well, lets see what happens when we want to expand that&hellip;</p>
<table>
<thead>
<tr>
<th>Accounts</th>
<th>Regions</th>
<th>API Calls</th>
<th>~ Time</th>
<th>Total Time (sec)</th>
<th>Total Time (min)</th>
</tr>
</thead>
<tbody>
<tr>
<td>5</td>
<td>3</td>
<td>50</td>
<td>~2s</td>
<td>~1500s</td>
<td>~25m</td>
</tr>
<tr>
<td>10</td>
<td>3</td>
<td>50</td>
<td>~2s</td>
<td>~3000s</td>
<td>~50m</td>
</tr>
<tr>
<td>30</td>
<td>3</td>
<td>50</td>
<td>~2s</td>
<td>~4500s</td>
<td>~75m</td>
</tr>
<tr>
<td>50</td>
<td>3</td>
<td>50</td>
<td>~2s</td>
<td>~15000s</td>
<td>~250m</td>
</tr>
<tr>
<td>100</td>
<td>3</td>
<td>50</td>
<td>~2s</td>
<td>~30000s</td>
<td>~500m</td>
</tr>
<tr>
<td>500</td>
<td>3</td>
<td>50</td>
<td>~2s</td>
<td>~150000s</td>
<td>~2500m</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Yeahhhhhhhhh&hellip;.. That doesnt really scale well does it&hellip;</p>
</blockquote>
<p>Well, I&rsquo;m not that great of a programmer, however, I worked with some other developers to create a set of scripts that allows us to query AWS endpoints through multi-processing. We&rsquo;re currently working on getting this deployed across the environment, but I wanted to share this with you. From now on we will refer to this repo: <a href="https://github.com/getsec/FiringRange">FiringRange</a></p>
<h1 id="quick-rundown-of-what-the-repo-holds">Quick rundown of what the repo holds<a href="#quick-rundown-of-what-the-repo-holds" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Long story short, it holds two scripts, which leverage some stuff in the helpers directory, what it does is assume role (you can update this in the barage or sniper script), and then run the commands passed in (refer to the README for more info). This is your run of the mill method, this doesnt really make things faster. Thats where the mp-barrage.py script comes along.</p>
<p>The MP Barrage script reads in commands from the gather-information directory, assigns them to a list, and dynamically generates a list of functions to run. It leverages the asyncio gather method, and runs them all at once. Check down below and I will show you a comparison of timing.</p>
<h1 id="the-traditional-method">The traditional method<a href="#the-traditional-method" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>For testing purposes we will use the same test case for both situations.</p>
<p><em>One Account, Two Regions, Five seperate API calls</em></p>
<ul>
<li>aws ec2 describe-instances</li>
<li>aws ec2 describe-security-groups</li>
<li>aws s3 list-buckets</li>
<li>aws iam list-roles</li>
<li>aws iam list-policies</li>
</ul>
<p>To test the barrage script we will use the following loop:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">
time python3 barrage -m -o -c <span style="color:#e6db74">&#34;aws ec2 describe-instances&#34;</span>       <span style="color:#75715e"># 5.208 total</span>
time python3 barrage -m -o -c <span style="color:#e6db74">&#34;aws ec2 describe-security-groups&#34;</span> <span style="color:#75715e"># 5.268 total</span>
time python3 barrage -m -o -c <span style="color:#e6db74">&#34;aws s3 list-buckets&#34;</span>              <span style="color:#75715e"># 2.859 total</span>
time python3 barrage -m -o -c <span style="color:#e6db74">&#34;aws iam list-roles&#34;</span>               <span style="color:#75715e"># 5.516 total</span>
time python3 barrage -m -o -c <span style="color:#e6db74">&#34;aws iam list-policies&#34;</span>            <span style="color:#75715e"># 14.037 total</span>

</code></pre></div><p>Thats a total of roughly 32 / 33 seconds. Now if we run this with the MP Barrage script the time should be down drasically. For this test we will replace the all-cmds file with only the API requests above.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">time python mp-barrage.py  <span style="color:#75715e"># 13.672 total</span>
</code></pre></div><p>Damn - pretty much sheds the time in half, currently I dont have the ability to run the old barrage script against multiple endpoints easily, but if we use the mp-barrage script, to scan one account, in three regions, with 41 endpoints, this is how long it takes.</p>
<blockquote>
<p>Keep in mind I&rsquo;m running this script on a 12 core computer - It maxes each core for the whole 13 seconds ^.^</p>
</blockquote>
<h1 id="examples">Examples<a href="#examples" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Example of the time running the script
<a href="https://asciinema.org/a/2cShOQoo5sEQW80AdC7t62YSb"><img src="https://asciinema.org/a/2cShOQoo5sEQW80AdC7t62YSb.svg" alt="asciicast"></a></p>
<p>Example of the output being filled up.
<a href="https://asciinema.org/a/oTQno3cqlNfNM5eV9qAGZGevg"><img src="https://asciinema.org/a/oTQno3cqlNfNM5eV9qAGZGevg.svg" alt="asciicast"></a></p>
<h1 id="conclusion">Conclusion<a href="#conclusion" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Based off the above input it seems that this method provides a very fast and efficient way to query lots of AWS API endpoints to gather information.</p>
<p>Hopefully this helps you all out :D</p>

      </div></div>
  
  <div class="pagination">
    <div class="pagination__title">
      <span
        class="pagination__title-h"></span>
      <hr />
    </div>
    <div class="pagination__buttons">
      
      <span class="button previous">
        <a href="/posts/bandit/">
          <span class="button__icon">←</span>
          <span class="button__text">Call the police - we got a bandit.</span>
        </a>
      </span>
      
      
    </div>
  </div>
  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2020 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>





  
</div>

</body>
</html>
